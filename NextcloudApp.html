<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing a Nextcloud Application &mdash; NcPyApi 0.0.40 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="_static/autodoc_pydantic.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/styles.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/dark.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/light.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=84bd753f"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="_static/copybutton.js?v=f281be69"></script>
        <script src="_static/tabs.js?v=3ee01567"></script>
        <script src="_static/js/script.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Writing System Nextcloud Application" href="NextcloudSysApp.html" />
    <link rel="prev" title="More APIs" href="MoreAPIs.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            NcPyApi
              <img src="_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.0.40
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="FirstSteps.html">First steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="MoreAPIs.html">More APIs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing a Nextcloud Application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#skeleton">Skeleton</a></li>
<li class="toctree-l2"><a class="reference internal" href="#debugging">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pack-deploy">Pack &amp; Deploy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#from-skeleton-to-togif">From skeleton to ToGif</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="NextcloudSysApp.html">Writing System Nextcloud Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="Options.html">Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="DevSetup.html">Setting up dev environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks/AppEcosystem.html">AppEcosystem Benchmarks</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NcPyApi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Writing a Nextcloud Application</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/NextcloudApp.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="writing-a-nextcloud-application">
<h1>Writing a Nextcloud Application<a class="headerlink" href="#writing-a-nextcloud-application" title="Link to this heading"></a></h1>
<p>This chapter assumes that you are already familiar with the <a class="reference external" href="https://cloud-py-api.github.io/app_ecosystem_v2/Concepts.html">concepts</a> of the AppEcosystem.</p>
<p>As a first step, let’s take a look at the structure of a basic Python application.</p>
<section id="skeleton">
<h2>Skeleton<a class="headerlink" href="#skeleton" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Simplest example.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="kn">from</span> <span class="nn">nc_py_api</span> <span class="kn">import</span> <span class="n">NextcloudApp</span>
<span class="kn">from</span> <span class="nn">nc_py_api.ex_app</span> <span class="kn">import</span> <span class="n">LogLvl</span><span class="p">,</span> <span class="n">run_app</span><span class="p">,</span> <span class="n">set_handlers</span>

<span class="n">APP</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">enabled_handler</span><span class="p">(</span><span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">nc</span><span class="p">:</span> <span class="n">NextcloudApp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># This will be called each time application is `enabled` or `disabled`</span>
    <span class="c1"># All scopes that application required already granted before this step.</span>
    <span class="c1"># NOTE: `user` is unavailable on this step, so all NC API calls that require it will fail as unauthorized.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;enabled=</span><span class="si">{</span><span class="n">enabled</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">enabled</span><span class="p">:</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LogLvl</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Hello from </span><span class="si">{</span><span class="n">nc</span><span class="o">.</span><span class="n">app_cfg</span><span class="o">.</span><span class="n">app_name</span><span class="si">}</span><span class="s2"> :)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LogLvl</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Bye bye from </span><span class="si">{</span><span class="n">nc</span><span class="o">.</span><span class="n">app_cfg</span><span class="o">.</span><span class="n">app_name</span><span class="si">}</span><span class="s2"> :(&quot;</span><span class="p">)</span>
    <span class="c1"># In case of an error, a non-empty short string should be returned, which will be shown to the NC administrator.</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="c1"># Of course, you can use `FastAPI lifespan: &lt;https://fastapi.tiangolo.com/advanced/events/#lifespan&gt;` instead of this.</span>
<span class="c1"># The only requirement for the application is to define `/enabled` and `/heartbeat` handlers.</span>
<span class="nd">@APP</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">initialization</span><span class="p">():</span>
    <span class="n">set_handlers</span><span class="p">(</span><span class="n">APP</span><span class="p">,</span> <span class="n">enabled_handler</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Wrapper around `uvicorn.run`.</span>
    <span class="c1"># You are free to call it directly, just use `APP_HOST` and `APP_PORT` from the environment.</span>
    <span class="n">run_app</span><span class="p">(</span><span class="s2">&quot;main:APP&quot;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;trace&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>What’s going on in the skeleton?</p>
<p>First, it’s important to understand that an external application acts more like a microservice, with its endpoints being called by Nextcloud.</p>
<p>Therefore, when the application receives a request at the endpoint <code class="docutils literal notranslate"><span class="pre">/enable</span></code>,
it should register all its functionalities in the cloud and wait for requests from Nextcloud.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This doesn’t apply to system applications, which will be covered in the next chapter.</p>
</div>
<p>So, calling:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">set_handlers</span><span class="p">(</span><span class="n">APP</span><span class="p">,</span> <span class="n">enabled_handler</span><span class="p">)</span>
</pre></div>
</div>
<p>will register an <strong>enabled_handler</strong> that will be called <strong>both when the application is enabled and disabled</strong>.</p>
<p>During the enablement process, you should register all the functionalities that your application offers
in the <strong>enabled_handler</strong> and remove them during the disablement process.</p>
<p>The API is designed so that you don’t have to check whether an endpoint is already registered
(e.g., in case of a malfunction or if the administrator manually altered something in the Nextcloud database).
The API will not fail, and in such cases, it will simply re-register without error.</p>
<p>If any error prevents your application from functioning, you should provide a brief description in the return instead
of an empty string, and log comprehensive information that will assist the administrator in addressing the issue.</p>
</section>
<section id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Link to this heading"></a></h2>
<p>Debugging an application within Docker and rebuilding it from scratch each time can be cumbersome.
Therefore, a manual deployment option has been specifically designed for this purpose.</p>
<p>First register <code class="docutils literal notranslate"><span class="pre">manual_install</span></code> daemon:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>php<span class="w"> </span>occ<span class="w"> </span>app_ecosystem_v2:daemon:register<span class="w"> </span>manual_install<span class="w"> </span><span class="s2">&quot;Manual Install&quot;</span><span class="w"> </span>manual-install<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
<p>Then, launch your application. Since this is a manual deployment, it’s your responsibility to set minimum of the environment variables.
Here they are:</p>
<ul class="simple">
<li><p>APP_ID - ID of the application.</p></li>
<li><p>APP_PORT - Port on which application listen for the requests from the Nextcloud.</p></li>
<li><p>APP_SECRET - Secret for <code class="docutils literal notranslate"><span class="pre">hmac</span></code> signature generation.</p></li>
<li><p>APP_VERSION - Version of the application.</p></li>
<li><p>AE_VERSION - Version of the AppEcosystem.</p></li>
<li><p>NEXTCLOUD_URL - URL at which the application can access the Nextcloud API.</p></li>
</ul>
<p>You can find values for these environment variables in the <strong>Skeleton</strong> or <strong>ToGif</strong> run configurations.</p>
<p>After launching your application, execute the following command in the Nextcloud container:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>php<span class="w"> </span>occ<span class="w"> </span>app_ecosystem_v2:app:register<span class="w"> </span>YOUR_APP_ID<span class="w"> </span>manual_install<span class="w"> </span>--json-info<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s2">&quot;{\&quot;appid\&quot;:\&quot;YOUR_APP_ID\&quot;,\&quot;name\&quot;:\&quot;YOUR_APP_DISPLAY_NAME\&quot;,\&quot;daemon_config_name\&quot;:\&quot;manual_install\&quot;,\&quot;version\&quot;:\&quot;YOU_APP_VERSION\&quot;,\&quot;secret\&quot;:\&quot;YOUR_APP_SECRET\&quot;,\&quot;host\&quot;:\&quot;host.docker.internal\&quot;,\&quot;scopes\&quot;:{\&quot;required\&quot;:[2, 10, 11],\&quot;optional\&quot;:[30, 31, 32, 33]},\&quot;port\&quot;:SELECTED_PORT,\&quot;protocol\&quot;:\&quot;http\&quot;,\&quot;system_app\&quot;:0}&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span>--force-scopes
</pre></div>
</div>
<p>You can see how <strong>nc_py_api</strong> registers in <code class="docutils literal notranslate"><span class="pre">scripts/dev_register.sh</span></code>.</p>
<p>It’s advisable to write these steps as commands in a Makefile for quick use.</p>
<p>Examples for such Makefiles can be found in this repository:
<a class="reference external" href="https://github.com/cloud-py-api/nc_py_api/blob/main/examples/as_app/skeleton/Makefile">Skeleton</a> ,
<a class="reference external" href="https://github.com/cloud-py-api/nc_py_api/blob/main/examples/as_app/to_gif/Makefile">ToGif</a> ,
<a class="reference external" href="https://github.com/cloud-py-api/nc_py_api/blob/main/scripts/dev_register.sh">nc_py_api</a></p>
<p>During the execution of <cite>php occ app_ecosystem_v2:app:register</cite>, the <strong>enabled_handler</strong> will be called,
as we pass the flag <code class="docutils literal notranslate"><span class="pre">-e</span></code>, meaning <code class="docutils literal notranslate"><span class="pre">enable</span> <span class="pre">after</span> <span class="pre">registration</span></code>.</p>
<p>This is likely all you need to start debugging and developing an application for Nextcloud.</p>
</section>
<section id="pack-deploy">
<h2>Pack &amp; Deploy<a class="headerlink" href="#pack-deploy" title="Link to this heading"></a></h2>
<p>Before reading this chapter, please review the basic information about deployment
and the currently supported types of
<a class="reference external" href="https://cloud-py-api.github.io/app_ecosystem_v2/DeployConfigurations.html">deployments configurations</a> in the AppEcosystem documentation.</p>
<p>to-do</p>
</section>
<section id="from-skeleton-to-togif">
<h2>From skeleton to ToGif<a class="headerlink" href="#from-skeleton-to-togif" title="Link to this heading"></a></h2>
<p>to-do</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="MoreAPIs.html" class="btn btn-neutral float-left" title="More APIs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="NextcloudSysApp.html" class="btn btn-neutral float-right" title="Writing System Nextcloud Application" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 Nextcloud GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>